generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User accounts
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  phone     String?
  firstName String?  @map("first_name")
  lastName  String?  @map("last_name")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  benefits     WicBenefit[]
  transactions Transaction[]
  shoppingList ShoppingListItem[]
  flags        ProductFlag[]

  @@map("users")
}

// WIC Benefits per user
model WicBenefit {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  category        String // 'milk', 'produce', 'grains', 'cereal'
  totalAmount     Decimal  @map("total_amount") @db.Decimal(10, 2)
  remainingAmount Decimal  @map("remaining_amount") @db.Decimal(10, 2)
  unit            String // 'gallons', 'dollars', 'packages', 'ounces'
  monthPeriod     String   @map("month_period")
  expiresAt       DateTime @map("expires_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("wic_benefits")
}

// WIC-Approved Stores
model WicStore {
  id        String   @id @default(uuid())
  name      String
  chain     String? // 'Walmart', 'Target', etc.
  address   String
  city      String
  state     String
  zipCode   String   @map("zip_code")
  latitude  Decimal  @db.Decimal(10, 8)
  longitude Decimal  @db.Decimal(11, 8)
  phone     String?
  hoursJson Json?    @map("hours_json")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  transactions Transaction[]

  @@map("wic_stores")
}

// General Foods Database (all foods, not just WIC-approved)
model GeneralFood {
  id          String   @id @default(uuid())
  name        String
  brand       String?
  category    String // 'dairy', 'produce', 'grains', 'cereal', 'meat', 'snacks', etc.
  subcategory String?
  upcCode     String?  @map("upc_code")
  pluCode     String?  @map("plu_code")
  description String?
  imageUrl    String?  @map("image_url")
  unitSize    String?  @map("unit_size")
  nutrition   Json? // Calories, protein, etc.
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  approvedFood ApprovedFood?
  recipeItems  RecipeItem[]

  @@unique([upcCode])
  @@unique([pluCode])
  @@index([category])
  @@index([upcCode])
  @@index([pluCode])
  @@map("general_foods")
}

// WIC-Approved Foods (subset of General Foods)
model ApprovedFood {
  id            String   @id @default(uuid())
  generalFoodId String   @unique @map("general_food_id")
  wicCategory   String   @map("wic_category") // 'milk', 'produce', 'grains', 'cereal'
  isApproved    Boolean  @default(true) @map("is_approved")
  approvedDate  DateTime @default(now()) @map("approved_date")
  notes         String? // Special WIC notes or restrictions
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  generalFood      GeneralFood        @relation(fields: [generalFoodId], references: [id], onDelete: Cascade)
  transactionItems TransactionItem[]

  @@index([wicCategory])
  @@map("approved_foods")
}

// Customer Transactions
model Transaction {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  storeId         String?  @map("store_id")
  transactionType String   @map("transaction_type") // 'purchase', 'reset'
  transactionDate DateTime @default(now()) @map("transaction_date")
  createdAt       DateTime @default(now()) @map("created_at")

  user  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  store WicStore? @relation(fields: [storeId], references: [id], onDelete: SetNull)
  items TransactionItem[]

  @@index([userId])
  @@index([transactionDate])
  @@map("transactions")
}

// Items in each transaction
model TransactionItem {
  id              String   @id @default(uuid())
  transactionId   String   @map("transaction_id")
  approvedFoodId  String?  @map("approved_food_id")
  category        String
  quantity        Decimal  @db.Decimal(10, 2)
  unit            String
  productName     String   @map("product_name") // Stored in case product deleted
  createdAt       DateTime @default(now()) @map("created_at")

  transaction  Transaction   @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  approvedFood ApprovedFood? @relation(fields: [approvedFoodId], references: [id], onDelete: SetNull)

  @@index([transactionId])
  @@map("transaction_items")
}

// Recipes using WIC-approved foods
model Recipe {
  id           String   @id @default(uuid())
  name         String
  description  String?
  prepTime     Int?     @map("prep_time") // minutes
  cookTime     Int?     @map("cook_time") // minutes
  servings     Int?
  difficulty   String? // 'easy', 'medium', 'hard'
  imageUrl     String?  @map("image_url")
  instructions String[] // Array of step-by-step instructions
  tags         String[] // 'breakfast', 'lunch', 'dinner', 'snack', 'healthy', etc.
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  items RecipeItem[]

  @@map("recipes")
}

// Ingredients in each recipe
model RecipeItem {
  id            String  @id @default(uuid())
  recipeId      String  @map("recipe_id")
  generalFoodId String? @map("general_food_id")
  ingredient    String // "2 cups whole milk" or "1 lb ground beef"
  quantity      String? // "2"
  unit          String? // "cups"
  isWicEligible Boolean @default(false) @map("is_wic_eligible")

  recipe      Recipe       @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  generalFood GeneralFood? @relation(fields: [generalFoodId], references: [id], onDelete: SetNull)

  @@index([recipeId])
  @@map("recipe_items")
}

// Shopping Lists
model ShoppingListItem {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  itemName  String   @map("item_name")
  isChecked Boolean  @default(false) @map("is_checked")
  category  String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("shopping_lists")
}

// Product Flagging (report issues)
model ProductFlag {
  id              String   @id @default(uuid())
  userId          String?  @map("user_id")
  generalFoodId   String   @map("general_food_id")
  flagReason      String   @map("flag_reason")
  status          String   @default("pending") // 'pending', 'reviewed', 'resolved'
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("product_flags")
}
